name: CI Calc

on:
  push:
  pull_request:

jobs:
  build-test-doc:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installer PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Installer Composer
        run: |
          curl -sS https://getcomposer.org/installer \
            | php -- --install-dir=/usr/local/bin --filename=composer

      - name: Installer les dépendances (phpDocumentor)
        run: composer install --no-interaction --prefer-dist

      # 1) Lint : vérifier que le PHP est syntaxiquement valide
      - name: Lint PHP (php -l)
        run: php -l calculatrice.php

      # 2) Test de bug : vérifier que la calculatrice ne "bug" pas
      - name: Test de comportement (2 + 2 = 4)
        run: ./test_bug.sh

      # 3) Génération de la documentation
      - name: Générer la documentation (phpDocumentor) sans casser la CI
      run: |
      if [ -f vendor/bin/phpdoc ]; then
       vendor/bin/phpdoc -d calculatrice.php -t docs/api || echo "phpDocumentor a échoué (ok pour la démo)"
      else
       echo "phpDocumentor non installé"
      fi


      # 4) Sauvegarder la doc comme artefact
      - name: Upload de la doc générée
        uses: actions/upload-artifact@v4
        with:
          name: calc-api-docs
          path: docs-api
